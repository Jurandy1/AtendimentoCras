(() => {
  const { query, collection, where, limit, onSnapshot } = window.firebaseModules;
const { COR_PRINCIPAL, maskCPF } = window.Utils;
  const { AlertCircle } = window.Icons;
  const { useState, useEffect } = React;
const PainelTV = ({ db, appId, crasUnidades, tiposAtendimento, atendentesList }) => { const [selectedCrasId, setSelectedCrasId] = useState(null); const [chamando, setChamando] = useState(null); const [ultimosChamados, setUltimosChamados] = useState([]); const [currentTime, setCurrentTime] = useState(new Date()); const [error, setError] = useState(null); const collectionPath = `artifacts/${appId}/public/data/atendimentos`; useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer); }, []); useEffect(() => { try { const params = new URLSearchParams(window.location.search); const crasIdFromUrl = params.get('cras_id'); if (crasIdFromUrl) { setSelectedCrasId(crasIdFromUrl); } } catch {} }, []); useEffect(() => { if (!db || !selectedCrasId) return; const qChamando = query(collection(db, collectionPath), where("cras_id", "==", selectedCrasId), where("status", "==", "chamando"), limit(1)); const unsubscribe = onSnapshot(qChamando, (snapshot) => { if (snapshot.empty) { setChamando(null); } else { const docData = snapshot.docs[0].data(); const tipo = tiposAtendimento.find(t => t.id === docData.tipo_atendimento_id); const atendente = atendentesList.find(a => a.id === docData.atendente_id); setChamando({ ...docData, tipo_nome: tipo?.nome || 'Atendimento', tipo_cor: tipo?.cor || '#333', atendente_nome: atendente?.nome || 'Atendente', atendente_guiche: atendente?.guiche || '?' }); } }, () => { setError("Erro ao buscar chamada principal."); }); return () => unsubscribe(); }, [db, selectedCrasId, appId, collectionPath, tiposAtendimento, atendentesList]); useEffect(() => { if (!db || !selectedCrasId) return; const qUltimos = query(collection(db, collectionPath), where("cras_id", "==", selectedCrasId), where("status", "==", "em_atendimento"), limit(2)); const unsubscribe = onSnapshot(qUltimos, (snapshot) => { const chamadosList = snapshot.docs.map(doc => { const docData = doc.data(); const tipo = tiposAtendimento.find(t => t.id === docData.tipo_atendimento_id); const atendente = atendentesList.find(a => a.id === docData.atendente_id); return { ...docData, tipo_nome: tipo?.nome || 'Atendimento', atendente_guiche: atendente?.guiche || '?' }; }); setUltimosChamados(chamadosList); }, () => { setError("Erro ao buscar últimos chamados."); }); return () => unsubscribe(); }, [db, selectedCrasId, appId, collectionPath, tiposAtendimento, atendentesList]); if (!selectedCrasId) { return (<div className="flex flex-col items-center justify-center h-screen bg-gray-100 p-8"><img src="https://placehold.co/300x100/1351B4/FFFFFF?text=Logo+Prefeitura" alt="Logo Prefeitura" className="mb-8" /><h1 className="text-4xl font-bold text-gray-800 mb-6">Selecione a Unidade CRAS</h1><p className="text-lg text-gray-600 mb-8">Este painel precisa ser configurado para uma unidade específica.</p>{crasUnidades.length === 0 && <p>Carregando unidades...</p>}<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{crasUnidades.map(cras => (<button key={cras.id} onClick={() => setSelectedCrasId(cras.id)} className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all text-left"><h2 className="text-2xl font-semibold text-blue-700">{cras.nome}</h2><p className="text-gray-600">{cras.bairro}</p></button>))}</div><p className="text-sm text-gray-500 mt-8">Se a sua unidade não aparece, verifique o cadastro na tela de <strong className="text-gray-600">Administração</strong>.</p></div>); } const crasAtual = crasUnidades.find(c => c.id === selectedCrasId); return (<div className="flex h-screen w-screen bg-gray-900 text-white font-sans overflow-hidden"><div className="w-2/3 h-full flex flex-col p-8" style={{ backgroundColor: '#050A1C' }}><header className="flex justify-between items-center mb-6"><img src="https://placehold.co/250x80/FFFFFF/1351B4?text=Logo+Prefeitura" alt="Logo Prefeitura" className="h-16" /><div className="text-right"><h1 className="text-4xl font-bold">{crasAtual?.nome || 'Painel CRAS'}</h1><h2 className="text-5xl font-light tracking-wider">{currentTime.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}</h2></div></header><main className="flex-1 flex items-center justify-center rounded-lg" style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)' }}>{chamando ? (<div className="w-full h-full flex flex-col justify-between p-10 rounded-lg" style={{ backgroundColor: chamando.tipo_cor || COR_PRINCIPAL }}><div className="text-center"><h3 className="text-5xl font-semibold uppercase tracking-widest text-white text-opacity-90">Chamando para Atendimento</h3><hr className="border-t-2 border-white border-opacity-50 my-4" /></div><div className="text-center my-8"><span className="text-4xl font-medium text-white text-opacity-80">Cidadão(ã)</span><h4 className="text-9xl font-bold uppercase truncate" style={{ lineHeight: '1.1' }}>{chamando.cidadao.nome}</h4><span className="text-5xl font-light text-white text-opacity-80">{maskCPF(chamando.cidadao.cpf)}</span></div><div className="flex justify-between items-end text-center"><div><span className="text-3xl font-medium text-white text-opacity-80 block">Tipo</span><span className="text-4xl font-semibold uppercase">{chamando.tipo_nome}</span></div><div><span className="text-3xl font-medium text-white text-opacity-80 block">Atendente</span><span className="text-4xl font-semibold uppercase">{chamando.atendente_nome}</span></div><div><span className="text-3xl font-medium text-white text-opacity-80 block">Dirija-se ao</span><span className="text-8xl font-bold bg-white text-black px-6 py-2 rounded-lg">{`GUICHÊ ${chamando.atendente_guiche}`}</span></div></div></div>) : (<div className="text-center text-gray-400"><h3 className="text-9xl font-bold text-white mb-4">{currentTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</h3><p className="text-5xl font-light">Aguardando Próxima Chamada</p></div>)}</main></div><div className="w-1/3 h-full bg-gray-800 p-8 flex flex-col"><h3 className="text-4xl font-semibold text-center uppercase mb-6 pb-4 border-b-2 border-gray-600">Últimos Chamados</h3><div className="space-y-6 flex-1">{ultimosChamados.length === 0 && (<div className="h-full flex items-center justify-center text-gray-500 text-2xl">Nenhum atendimento em andamento.</div>)}{ultimosChamados.map(atendimento => (<div key={atendimento.senha} className="bg-gray-700 p-5 rounded-lg shadow-lg border-l-8 border-green-500"><div className="flex justify-between items-baseline mb-1"><h4 className="text-4xl font-bold text-white truncate">{atendimento.cidadao.nome}</h4><span className="text-3xl font-semibold text-white">{`Guichê ${atendimento.atendente_guiche}`}</span></div><p className="text-2xl text-gray-300">{maskCPF(atendimento.cidadao.cpf)}</p><p className="text-xl font-semibold text-green-300 mt-2">{atendimento.tipo_nome}</p></div>))}</div></div>{error && (<div className="absolute bottom-4 left-4 bg-red-600 text-white p-4 rounded-lg flex items-center"><AlertCircle size={24} className="mr-2" /> {error}</div>)}</div>); };
  window.Components = window.Components || {}; window.Components.PainelTV = PainelTV;
})();
