(() => {
  const { collection, query, onSnapshot, doc, updateDoc, addDoc, deleteDoc } = window.firebaseModules;
  const { UserCog, Edit, Trash2, EyeOff, Eye } = window.Icons;
  const { } = window.Utils;
  const { useState, useEffect } = React;
const GerenciarAtendentes = ({ db, appId, crasUnidades, tiposAtendimento }) => { const [atendentes, setAtendentes] = useState([]); const [loading, setLoading] = useState(true); const [formData, setFormData] = useState({ nome: '', email: '', senha: '', cras_id: '', guiche: '', tipos_atende: [] }); const [editingId, setEditingId] = useState(null); const [showModal, setShowModal] = useState(false); const [showPassword, setShowPassword] = useState(false); const collectionPath = `artifacts/${appId}/public/data/atendentes`; useEffect(() => { if (!db) return; setLoading(true); const q = query(collection(db, collectionPath)); const unsubscribe = onSnapshot(q, (snapshot) => { const dataList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setAtendentes(dataList); setLoading(false); }, () => { setLoading(false); }); return () => unsubscribe(); }, [db, appId, collectionPath]); const getTipoNome = (id) => tiposAtendimento.find(t => t.id === id)?.nome || 'Desconhecido'; const getTipoCor = (id) => tiposAtendimento.find(t => t.id === id)?.cor || '#777'; const getCrasNome = (id) => crasUnidades.find(c => c.id === id)?.nome || 'Sem CRAS'; const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); }; const handleTipoToggle = (tipoId) => { setFormData(prev => { const tipos = prev.tipos_atende || []; if (tipos.includes(tipoId)) { return { ...prev, tipos_atende: tipos.filter(id => id !== tipoId) }; } else { return { ...prev, tipos_atende: [...tipos, tipoId] }; } }); }; const resetForm = () => { setFormData({ nome: '', email: '', senha: '', cras_id: '', guiche: '', tipos_atende: [] }); setEditingId(null); setShowModal(false); setShowPassword(false); }; const handleSubmit = async (e) => { e.preventDefault(); if (!db) return; const dataToSave = { ...formData }; if (!editingId && !dataToSave.senha) { return; } if (editingId && !dataToSave.senha) { delete dataToSave.senha; } try { if (editingId) { const docRef = doc(db, collectionPath, editingId); await updateDoc(docRef, dataToSave); } else { await addDoc(collection(db, collectionPath), dataToSave); } resetForm(); } catch (error) {} }; const handleEdit = (atendente) => { setFormData({ nome: atendente.nome, email: atendente.email, senha: '', cras_id: atendente.cras_id, guiche: atendente.guiche, tipos_atende: atendente.tipos_atende || [] }); setEditingId(atendente.id); setShowModal(true); }; const handleDelete = async (id) => { try { const docRef = doc(db, collectionPath, id); await deleteDoc(docRef); } catch (error) {} }; return (<div className="p-4"><div className="flex justify-between items-center mb-4"><h3 className="text-2xl font-semibold">Gerenciar Atendentes</h3><button onClick={() => { resetForm(); setShowModal(true); }} className="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors"><UserCog size={18} className="mr-2" /> Novo Atendente</button></div>{showModal && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"><h4 className="text-xl font-semibold mb-4">{editingId ? 'Editar Atendente' : 'Novo Atendente'}</h4><form onSubmit={handleSubmit} className="space-y-4"><input name="nome" value={formData.nome} onChange={handleChange} placeholder="Nome Completo" required className="w-full p-2 border rounded-lg" /><input name="email" type="email" value={formData.email} onChange={handleChange} placeholder="Email" required className="w-full p-2 border rounded-lg" /><div className="relative"><input name="senha" type={showPassword ? 'text' : 'password'} value={formData.senha} onChange={handleChange} placeholder={editingId ? 'Deixe em branco para não alterar' : 'Senha'} required={!editingId} className="w-full p-2 border rounded-lg pr-10" /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">{showPassword ? <EyeOff size={18} /> : <Eye size={18} />}</button></div><select name="cras_id" value={formData.cras_id} onChange={handleChange} required className="w-full p-2 border rounded-lg bg-white"><option value="">Selecione a Unidade CRAS</option>{crasUnidades.map(cras => (<option key={cras.id} value={cras.id}>{cras.nome}</option>))}</select><input name="guiche" value={formData.guiche} onChange={handleChange} placeholder="Nº do Guichê" required className="w-full p-2 border rounded-lg" /><div><label className="block text-sm font-medium text-gray-700 mb-2">Tipos de Atendimento:</label><div className="space-y-2 max-h-40 overflow-y-auto border p-2 rounded-lg">{tiposAtendimento.map(tipo => (<label key={tipo.id} className="flex items-center space-x-2 cursor-pointer"><input type="checkbox" checked={formData.tipos_atende.includes(tipo.id)} onChange={() => handleTipoToggle(tipo.id)} className="rounded" /><span className="px-2 py-0.5 rounded-full text-xs font-medium" style={{ backgroundColor: getTipoCor(tipo.id), color: '#fff' }}>{getTipoNome(tipo.id)}</span></label>))}</div></div><div className="flex justify-end space-x-2"><button type="button" onClick={resetForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">{editingId ? 'Atualizar' : 'Salvar'}</button></div></form></div></div>)}{loading ? (<p>Carregando atendentes...</p>) : (<div className="bg-white shadow rounded-lg overflow-x-auto"><table className="w-full min-w-[800px]"><thead className="bg-gray-50"><tr><th className="p-3 text-left text-sm font-semibold text-gray-600">Nome</th><th className="p-3 text-left text-sm font-semibold text-gray-600">CRAS</th><th className="p-3 text-left text-sm font-semibold text-gray-600">Guichê</th><th className="p-3 text-left text-sm font-semibold text-gray-600">Tipos</th><th className="p-3 text-left text-sm font-semibold text-gray-600">Ações</th></tr></thead><tbody className="divide-y divide-gray-200">{atendentes.map(a => (<tr key={a.id}><td className="p-3">{a.nome}</td><td className="p-3">{getCrasNome(a.cras_id)}</td><td className="p-3">{a.guiche}</td><td className="p-3"><div className="flex flex-wrap gap-1">{(a.tipos_atende || []).map(id => (<span key={id} className="px-2 py-0.5 rounded-full text-xs font-medium" style={{ backgroundColor: getTipoCor(id), color: '#fff' }}>{getTipoNome(id)}</span>))}</div></td><td className="p-3"><div className="flex space-x-2"><button onClick={() => handleEdit(a)} className="text-blue-600 hover:text-blue-800"><Edit size={18} /></button><button onClick={() => handleDelete(a.id)} className="text-red-600 hover:text-red-800"><Trash2 size={18} /></button></div></td></tr>))}</tbody></table></div>)}</div>); };
  window.Components = window.Components || {}; window.Components.GerenciarAtendentes = GerenciarAtendentes;
})();
