(() => {
  const { query, collection, where, getDocs, Timestamp } = window.firebaseModules;
  const { Loader, Filter, Download } = window.Icons;
  const { formatDateTime, calculateDuration } = window.Utils;
  const { useState } = React;
const Relatorios = ({ db, appId, crasUnidades, tiposAtendimento }) => { const [filters, setFilters] = useState({ dataInicio: '', dataFim: '', cras_id: 'todos', tipo_atendimento_id: 'todos', status: 'todos' }); const [reportData, setReportData] = useState([]); const [loading, setLoading] = useState(false); const [error, setError] = useState(null); const collectionPath = `artifacts/${appId}/public/data/atendimentos`; const handleChange = (e) => { const { name, value } = e.target; setFilters(prev => ({ ...prev, [name]: value })); }; const handleSearch = async () => { setLoading(true); setError(null); try { let baseQuery = query(collection(db, collectionPath)); if (filters.dataInicio) { const dataInicio = new Date(filters.dataInicio); dataInicio.setHours(0, 0, 0, 0); baseQuery = query(baseQuery, where("hora_chegada", ">=", Timestamp.fromDate(dataInicio))); } if (filters.dataFim) { const dataFim = new Date(filters.dataFim); dataFim.setHours(23, 59, 59, 999); baseQuery = query(baseQuery, where("hora_chegada", "<=", Timestamp.fromDate(dataFim))); } const snapshot = await getDocs(baseQuery); let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (filters.cras_id !== 'todos') { data = data.filter(item => item.cras_id === filters.cras_id); } if (filters.tipo_atendimento_id !== 'todos') { data = data.filter(item => item.tipo_atendimento_id === filters.tipo_atendimento_id); } if (filters.status !== 'todos') { data = data.filter(item => item.status === filters.status); } setReportData(data); } catch (err) { setError("Erro ao gerar relatório. Verifique os filtros ou os índices do Firestore. " + err.message); } finally { setLoading(false); } }; const getTipoNome = (id) => tiposAtendimento.find(t => t.id === id)?.nome || 'N/A'; const getCrasNome = (id) => crasUnidades.find(c => c.id === id)?.nome || 'N/A'; const handleExportCSV = () => { if (reportData.length === 0) return; const headers = ["ID", "DataHoraChegada", "Senha", "NomeCidadao", "CPFCidadao", "Sexo", "CRAS", "TipoAtendimento", "Status", "TempoAtendimentoMin", "Observacoes"]; const rows = reportData.map(item => { const data = [ item.id, formatDateTime(item.hora_chegada), item.senha, item.cidadao.nome, item.cidadao.cpf, item.cidadao.sexo, getCrasNome(item.cras_id), getTipoNome(item.tipo_atendimento_id), item.status, calculateDuration(item.hora_inicio, item.hora_fim).replace(' min', ''), (item.observacoes || '').replace(/"/g, '""') ]; return `"${data.join('","')}"`; }); const csvContent = "data:text/csv;charset=utf-8," + `"${headers.join('","')}"\n` + rows.join("\n"); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const timestamp = new Date().toISOString().slice(0, 16).replace(/[:T]/g, '-'); link.setAttribute("download", `relatorio_atendimentos_${timestamp}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }; const GraficoPorTipo = () => { const counts = useMemo(() => { const map = new Map(); reportData.forEach(item => { const nome = getTipoNome(item.tipo_atendimento_id); map.set(nome, (map.get(nome) || 0) + 1); }); return Array.from(map.entries()); }, [reportData]); return (<div className="bg-white p-6 rounded-lg shadow"><h4 className="text-lg font-semibold mb-4">Por Tipo de Atendimento</h4><ul className="space-y-2">{counts.map(([nome, total]) => (<li key={nome} className="flex justify-between"><span className="font-medium">{nome}</span><span>{total}</span></li>))}</ul></div>); }; const GraficoPorSexo = () => { const counts = useMemo(() => { const map = new Map(); reportData.forEach(item => { const sexo = item.cidadao.sexo || 'N/A'; map.set(sexo, (map.get(sexo) || 0) + 1); }); return Array.from(map.entries()); }, [reportData]); return (<div className="bg-white p-6 rounded-lg shadow"><h4 className="text-lg font-semibold mb-4">Por Sexo</h4><ul className="space-y-2">{counts.map(([sexo, total]) => (<li key={sexo} className="flex justify-between"><span className="font-medium">{sexo}</span><span>{total}</span></li>))}</ul></div>); }; const TabelaRelatorio = () => { return (<div className="bg-white p-6 rounded-lg shadow mt-6 overflow-x-auto"><table className="min-w-[900px] w-full"><thead><tr className="bg-gray-50"><th className="p-2 text-left text-sm font-semibold text-gray-600">ID</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Chegada</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Senha</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Cidadão</th><th className="p-2 text-left text-sm font-semibold text-gray-600">CPF</th><th className="p-2 text-left text-sm font-semibold text-gray-600">CRAS</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Tipo</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Status</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Tempo (min)</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Obs</th></tr></thead><tbody className="divide-y divide-gray-200">{reportData.map(item => (<tr key={item.id}><td className="p-2 text-xs text-gray-500">{item.id}</td><td className="p-2">{formatDateTime(item.hora_chegada)}</td><td className="p-2 font-bold">{item.senha}</td><td className="p-2">{item.cidadao.nome}</td><td className="p-2">{item.cidadao.cpf}</td><td className="p-2">{getCrasNome(item.cras_id)}</td><td className="p-2">{getTipoNome(item.tipo_atendimento_id)}</td><td className="p-2">{item.status}</td><td className="p-2">{calculateDuration(item.hora_inicio, item.hora_fim).replace(' min', '')}</td><td className="p-2">{item.observacoes}</td></tr>))}</tbody></table></div>); }; return (<div className="p-6"><div className="flex justify-between items-center mb-4"><h3 className="text-2xl font-semibold">Relatórios</h3><button onClick={handleExportCSV} disabled={reportData.length === 0} className="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors disabled:bg-gray-400"><Download size={18} className="mr-2" /> Exportar CSV ({reportData.length})</button></div><div className="bg-white p-4 rounded-lg shadow"><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4"><input name="dataInicio" type="date" value={filters.dataInicio} onChange={handleChange} className="w-full p-2 border rounded-lg text-gray-600" title="Data Início" /><input name="dataFim" type="date" value={filters.dataFim} onChange={handleChange} className="w-full p-2 border rounded-lg text-gray-600" title="Data Fim" /><select name="cras_id" value={filters.cras_id} onChange={handleChange} className="w-full p-2 border rounded-lg bg-white"><option value="todos">Todas Unidades CRAS</option>{crasUnidades.map(cras => <option key={cras.id} value={cras.id}>{cras.nome}</option>)}</select><select name="tipo_atendimento_id" value={filters.tipo_atendimento_id} onChange={handleChange} className="w-full p-2 border rounded-lg bg-white"><option value="todos">Todos Tipos</option>{tiposAtendimento.map(tipo => <option key={tipo.id} value={tipo.id}>{tipo.nome}</option>)}</select><select name="status" value={filters.status} onChange={handleChange} className="w-full p-2 border rounded-lg bg-white"><option value="todos">Todos Status</option><option value="aguardando">Aguardando</option><option value="em_atendimento">Em Atendimento</option><option value="finalizado">Finalizado</option></select><button onClick={handleSearch} disabled={loading} className="flex items-center justify-center bg-blue-600 text-white p-2 rounded-lg shadow hover:bg-blue-700 disabled:bg-gray-400">{loading ? <Loader size={18} className="animate-spin" /> : <Filter size={18} className="mr-2" />}Filtrar</button></div>{error && <p className="text-red-600 text-sm mt-4">{error}</p>}</div>{loading ? (<div className="flex items-center justify-center p-20"><Loader className="animate-spin h-12 w-12 text-blue-600" /></div>) : reportData.length === 0 ? (<p className="text-gray-500 text-center p-20">Nenhum dado encontrado para os filtros selecionados.</p>) : (<><div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><GraficoPorTipo /><GraficoPorSexo /></div><TabelaRelatorio /></>)}</div>); };
  window.Components = window.Components || {}; window.Components.Relatorios = Relatorios;
})();
