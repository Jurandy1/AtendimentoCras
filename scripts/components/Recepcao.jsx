(() => {
  const { query, collection, where, getDocs, addDoc, serverTimestamp, Timestamp } = window.firebaseModules;
  const { Loader, Plus } = window.Icons;
  const { COR_PRINCIPAL, getStartOfToday } = window.Utils;
  const { useState } = React;
const Recepcao = ({ db, appId, tiposAtendimento, crasUnidades }) => { const [formData, setFormData] = useState({ nome: '', cpf: '', telefone: '', dataNascimento: '', sexo: '', cras_id: '', tipo_atendimento_id: '' }); const [gerandoSenha, setGerandoSenha] = useState(false); const [senhaGerada, setSenhaGerada] = useState(null); const [error, setError] = useState(null); const collectionPath = `artifacts/${appId}/public/data/atendimentos`; const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); }; const handleGerarSenha = async (e) => { e.preventDefault(); if (!db || !formData.cras_id || !formData.tipo_atendimento_id) { setError("Por favor, preencha todos os campos obrigatórios."); return; } setGerandoSenha(true); setError(null); try { const tipo = tiposAtendimento.find(t => t.id === formData.tipo_atendimento_id); if (!tipo) throw new Error("Tipo de atendimento não encontrado."); const prefixo = (tipo.nome[0] || 'A').toUpperCase(); const q = query(collection(db, collectionPath), where("cras_id", "==", formData.cras_id)); const querySnapshot = await getDocs(q); const inicioHoje = getStartOfToday(); const atendimentosHoje = querySnapshot.docs.filter(doc => { const data = doc.data(); if (!data.hora_chegada || typeof data.hora_chegada.toDate !== 'function') { return false; } return data.hora_chegada.toDate() >= inicioHoje; }); const totalHoje = atendimentosHoje.length; const numero = (totalHoje + 1).toString().padStart(3, '0'); const senha = `${prefixo}${numero}`; const dadosCidadao = { nome: formData.nome, cpf: formData.cpf.replace(/\D/g, ''), telefone: formData.telefone, dataNascimento: formData.dataNascimento, sexo: formData.sexo }; const docData = { cidadao: dadosCidadao, senha: senha, cras_id: formData.cras_id, tipo_atendimento_id: formData.tipo_atendimento_id, status: "aguardando", hora_chegada: serverTimestamp(), atendente_id: null, hora_chamada: null, hora_inicio: null, hora_fim: null, observacoes: "" }; const docRef = await addDoc(collection(db, collectionPath), docData); setSenhaGerada({ ...docData, id: docRef.id, tipo_nome: tipo.nome, tipo_cor: tipo.cor, hora_chegada: Timestamp.now() }); } catch (err) { setError(`Erro ao gerar senha: ${err.message}`); } finally { setGerandoSenha(false); } }; const handleNovoAtendimento = () => { setFormData({ nome: '', cpf: '', telefone: '', dataNascimento: '', sexo: '', cras_id: formData.cras_id, tipo_atendimento_id: '' }); setSenhaGerada(null); setError(null); }; if (senhaGerada) { return (<div className="flex flex-col items-center justify-center min-h-full p-4 md:p-10"><div className="bg-white shadow-2xl rounded-lg p-8 w-full max-w-md text-center border-t-8" style={{ borderColor: senhaGerada.tipo_cor || COR_PRINCIPAL }}><h2 className="text-2xl font-bold text-gray-800 mb-2">Senha Gerada com Sucesso!</h2><p className="text-gray-600 mb-6">Aguarde ser chamado no painel.</p><div className="bg-gray-50 p-6 rounded-lg mb-6"><span className="text-lg font-semibold text-gray-500">Sua Senha</span><h3 className="text-8xl font-bold text-gray-900 my-2">{senhaGerada.senha}</h3><span className="text-xl font-semibold px-4 py-1 rounded-full text-white" style={{ backgroundColor: senhaGerada.tipo_cor || COR_PRINCIPAL }}>{senhaGerada.tipo_nome}</span><div className="mt-4 text-gray-600"><p>CRAS: <span className="font-semibold">{crasUnidades.find(c => c.id === senhaGerada.cras_id)?.nome}</span></p><p>Chegada: <span className="font-semibold">{senhaGerada.hora_chegada.toDate().toLocaleString('pt-BR')}</span></p></div></div><div className="space-x-2"><button onClick={handleNovoAtendimento} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Novo Atendimento</button><a href={`${window.location.pathname}?page=PainelTV&cras_id=${senhaGerada.cras_id}`} target="_blank" rel="noopener noreferrer" className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-gray-300">Abrir Painel</a></div></div></div>); } return (<div className="p-6"><h2 className="text-3xl font-bold text-gray-800 mb-6">Recepção</h2><form onSubmit={handleGerarSenha} className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-lg shadow"><input name="nome" value={formData.nome} onChange={handleChange} placeholder="Nome Completo" required className="p-2 border rounded-lg" /><input name="cpf" value={formData.cpf} onChange={handleChange} placeholder="CPF" required className="p-2 border rounded-lg" /><input name="telefone" value={formData.telefone} onChange={handleChange} placeholder="Telefone" className="p-2 border rounded-lg" /><input name="dataNascimento" type="date" value={formData.dataNascimento} onChange={handleChange} className="p-2 border rounded-lg" /><select name="sexo" value={formData.sexo} onChange={handleChange} className="p-2 border rounded-lg bg-white"><option value="">Sexo</option><option value="F">Feminino</option><option value="M">Masculino</option></select><select name="cras_id" value={formData.cras_id} onChange={handleChange} required className="p-2 border rounded-lg bg-white"><option value="">Unidade CRAS</option>{crasUnidades.map(cras => (<option key={cras.id} value={cras.id}>{cras.nome}</option>))}</select><select name="tipo_atendimento_id" value={formData.tipo_atendimento_id} onChange={handleChange} required className="p-2 border rounded-lg bg-white"><option value="">Tipo de Atendimento</option>{tiposAtendimento.map(tipo => (<option key={tipo.id} value={tipo.id}>{tipo.nome}</option>))}</select><div className="md:col-span-2 flex justify-end"><button type="submit" disabled={gerandoSenha} className="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 disabled:bg-gray-400">{gerandoSenha ? <Loader className="animate-spin" /> : <Plus size={18} className="mr-2" />} Gerar Senha</button></div>{error && <p className="md:col-span-2 text-red-600">{error}</p>}</form></div>); };
  window.Components = window.Components || {}; window.Components.Recepcao = Recepcao;
})();
