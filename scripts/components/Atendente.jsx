(() => {
  const { query, collection, where, onSnapshot, limit, doc, updateDoc, getDoc, serverTimestamp } = window.firebaseModules;
const { Loader, ChevronRight, CheckCircle } = window.Icons;
const { maskCPF, formatDateTime, calculateWaitTime, formatTime } = window.Utils;
  const { useState, useEffect } = React;
const Atendente = ({ db, auth, appId, crasUnidades, tiposAtendimento, atendentesList }) => { const [selectedAtendente, setSelectedAtendente] = useState(null); const [filaAguardando, setFilaAguardando] = useState([]); const [atendimentoAtual, setAtendimentoAtual] = useState(null); const [loadingFila, setLoadingFila] = useState(false); const [loadingAtual, setLoadingAtual] = useState(false); const [observacoes, setObservacoes] = useState(""); const collectionPath = `artifacts/${appId}/public/data/atendimentos`; useEffect(() => { if (!db || !selectedAtendente) { setFilaAguardando([]); return; } setLoadingFila(true); const q = query(collection(db, collectionPath), where("cras_id", "==", selectedAtendente.cras_id), where("status", "==", "aguardando")); const unsubscribe = onSnapshot(q, (snapshot) => { const fila = snapshot.docs.map(doc => { const data = doc.data(); const tipo = tiposAtendimento.find(t => t.id === data.tipo_atendimento_id); return { id: doc.id, ...data, tipo_nome: tipo?.nome || 'Atendimento', tipo_cor: tipo?.cor || '#777' }; }); fila.sort((a, b) => a.hora_chegada.toMillis() - b.hora_chegada.toMillis()); const tiposPermitidos = selectedAtendente.tipos_atende || []; if (tiposPermitidos.length > 0) { setFilaAguardando(fila.filter(item => tiposPermitidos.includes(item.tipo_atendimento_id))); } else { setFilaAguardando(fila); } setLoadingFila(false); }, () => { setLoadingFila(false); }); return () => unsubscribe(); }, [db, selectedAtendente, collectionPath, tiposAtendimento]); useEffect(() => { if (!db || !selectedAtendente) { setAtendimentoAtual(null); return; } setLoadingAtual(true); const q = query(collection(db, collectionPath), where("atendente_id", "==", selectedAtendente.id), where("status", "in", ["chamando", "em_atendimento"]), limit(1)); const unsubscribe = onSnapshot(q, (snapshot) => { if (snapshot.empty) { setAtendimentoAtual(null); setObservacoes(""); } else { const docSnap = snapshot.docs[0]; const data = docSnap.data(); const tipo = tiposAtendimento.find(t => t.id === data.tipo_atendimento_id); setAtendimentoAtual({ id: docSnap.id, ...data, tipo_nome: tipo?.nome || 'Atendimento', tipo_cor: tipo?.cor || '#777' }); setObservacoes(data.observacoes || ""); } setLoadingAtual(false); }, () => { setLoadingAtual(false); }); return () => unsubscribe(); }, [db, selectedAtendente, collectionPath, tiposAtendimento]); const handleChamarProximo = async () => { if (!db || !selectedAtendente || filaAguardando.length === 0 || atendimentoAtual) return; const proximo = filaAguardando[0]; try { const docRef = doc(db, collectionPath, proximo.id); await updateDoc(docRef, { status: "chamando", atendente_id: selectedAtendente.id, hora_chamada: serverTimestamp() }); setTimeout(async () => { const ds = await getDoc(docRef); if (ds.exists() && ds.data().status === "chamando") { await updateDoc(docRef, { status: "em_atendimento", hora_inicio: serverTimestamp() }); } }, 5000); } catch {} }; const handleFinalizarAtendimento = async () => { if (!db || !atendimentoAtual) return; try { const docRef = doc(db, collectionPath, atendimentoAtual.id); await updateDoc(docRef, { status: "finalizado", hora_fim: serverTimestamp(), observacoes: observacoes }); setAtendimentoAtual(null); setObservacoes(""); } catch {} }; if (!selectedAtendente) { return (<div className="flex flex-col items-center justify-center min-h-full bg-gray-50 p-8"><h1 className="text-3xl font-bold text-gray-800 mb-6">Identificação do Atendente</h1><p className="text-lg text-gray-600 mb-8">Selecione seu perfil para iniciar.</p>{atendentesList.length === 0 && <p>Carregando perfis...</p>}<div className="w-full max-w-lg space-y-4">{atendentesList.map(atendente => (<button key={atendente.id} onClick={() => setSelectedAtendente(atendente)} className="w-full flex items-center justify-between bg-white p-6 rounded-lg shadow-md hover:shadow-lg hover:border-blue-500 border-2 border-transparent transition-all"><div><h2 className="text-2xl font-semibold text-blue-700">{atendente.nome}</h2><p className="text-gray-600">{crasUnidades.find(c => c.id === atendente.cras_id)?.nome}</p></div><span className="text-xl font-bold text-gray-700">{`Guichê ${atendente.guiche}`}</span></button>))}</div></div>); } return (<div className="flex h-full max-h-full overflow-hidden"><div className="flex-1 h-full p-6 overflow-y-auto"><header className="flex justify-between items-center mb-6"><div><h2 className="text-3xl font-bold text-gray-800">Painel do Atendente</h2><p className="text-xl text-gray-600">{selectedAtendente.nome} - <span className="font-semibold">{crasUnidades.find(c => c.id === selectedAtendente.cras_id)?.nome} (Guichê {selectedAtendente.guiche})</span></p></div><button onClick={() => setSelectedAtendente(null)} className="text-sm text-blue-600 hover:underline">Trocar de Perfil</button></header>{loadingAtual ? (<div className="h-64 flex items-center justify-center"><Loader className="animate-spin" /></div>) : atendimentoAtual ? (<div className="bg-white shadow-lg rounded-lg border-l-8 p-6" style={{ borderColor: atendimentoAtual.tipo_cor }}><div className="flex justify-between items-start"><div><span className={`text-sm font-bold uppercase ${atendimentoAtual.status === 'chamando' ? 'text-blue-600 animate-pulse' : 'text-green-600'}`}>{atendimentoAtual.status === 'chamando' ? 'CHAMANDO...' : 'EM ATENDIMENTO'}</span><h3 className="text-2xl font-bold text-gray-800">{atendimentoAtual.cidadao.nome}</h3><p className="text-gray-600">CPF: {maskCPF(atendimentoAtual.cidadao.cpf)}</p><p className="text-gray-600">Tipo: <span className="font-semibold" style={{ color: atendimentoAtual.tipo_cor }}>{atendimentoAtual.tipo_nome}</span></p><p className="text-gray-600">Chegada: {formatDateTime(atendimentoAtual.hora_chegada)}</p><p className="text-gray-600">Espera: {calculateWaitTime(atendimentoAtual.hora_chegada)}</p></div><div className="text-right"><span className="text-xl font-bold bg-gray-100 px-3 py-1 rounded">Guichê {selectedAtendente.guiche}</span></div></div><div className="mt-4"><textarea value={observacoes} onChange={(e) => setObservacoes(e.target.value)} placeholder="Observações do atendimento" className="w-full p-3 border rounded-lg" /></div><div className="mt-4 flex justify-end"><button onClick={handleFinalizarAtendimento} className="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700"><CheckCircle size={18} className="mr-2" /> Finalizar Atendimento</button></div></div>) : (<p className="text-gray-600">Nenhum atendimento em andamento.</p>)}<section className="mt-6"><div className="flex justify-between items-center mb-3"><h4 className="text-xl font-semibold">Fila de Aguardando</h4><button disabled={loadingFila || filaAguardando.length === 0 || !!atendimentoAtual} onClick={handleChamarProximo} className="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"><ChevronRight size={18} className="mr-2" /> Chamar Próximo</button></div>{loadingFila ? (<div className="h-32 flex items-center justify-center"><Loader className="animate-spin" /></div>) : filaAguardando.length === 0 ? (<p className="text-gray-500">Nenhum cidadão aguardando.</p>) : (<div className="bg-white rounded-lg shadow overflow-hidden"><table className="w-full"><thead className="bg-gray-50"><tr><th className="p-2 text-left text-sm font-semibold text-gray-600">Senha</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Nome</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Tipo</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Chegada</th><th className="p-2 text-left text-sm font-semibold text-gray-600">Espera</th></tr></thead><tbody className="divide-y divide-gray-200">{filaAguardando.map(item => (<tr key={item.id}><td className="p-2 font-bold">{item.senha}</td><td className="p-2">{item.cidadao.nome}</td><td className="p-2"><span className="px-2 py-0.5 rounded-full text-xs font-medium" style={{ backgroundColor: item.tipo_cor, color: '#fff' }}>{item.tipo_nome}</span></td><td className="p-2">{formatTime(item.hora_chegada)}</td><td className="p-2">{calculateWaitTime(item.hora_chegada)}</td></tr>))}</tbody></table></div>)}</section></div></div>); };
  window.Components = window.Components || {}; window.Components.Atendente = Atendente;
})();
